# 任务清单

## 1. 项目初始化

- [ ] 1.1 创建项目目录结构
- [ ] 1.2 初始化 Python 虚拟环境 (venv)
- [ ] 1.3 创建 requirements.txt
- [ ] 1.4 初始化 Next.js 前端项目
- [ ] 1.5 配置 PostgreSQL 数据库
- [ ] 1.6 创建 .env 配置文件模板

## 2. 数据库设计 (P0)

- [ ] 2.1 创建 SQLAlchemy 模型
  - [ ] 2.1.1 invite_links 表 (邀请链接)
  - [ ] 2.1.2 resources 表 (资源)
  - [ ] 2.1.3 media_files 表 (媒体文件)
  - [ ] 2.1.4 users 表 (用户)
  - [ ] 2.1.5 user_sessions 表 (用户会话)
  - [ ] 2.1.6 ad_groups 表 (广告组)
  - [ ] 2.1.7 sponsors 表 (赞助商广告)
  - [ ] 2.1.8 statistics 表 (统计事件)
  - [ ] 2.1.9 admins 表 (管理员)
  - [ ] 2.1.10 configs 表 (系统配置)
- [ ] 2.2 创建数据库迁移脚本
- [ ] 2.3 创建数据库连接模块

## 3. Bot 核心功能 (P0)

- [ ] 3.1 Bot 初始化和启动
- [ ] 3.2 Deep Link 解析和用户来源记录
- [ ] 3.3 用户识别逻辑 (老用户/新用户)
- [ ] 3.4 封面视频发送
- [ ] 3.5 FSM 状态管理
- [ ] 3.6 翻页逻辑实现
  - [ ] 3.6.1 等待时间计算 (2/3/4/5/5/5/5 秒)
  - [ ] 3.6.2 倒计时消息展示
  - [ ] 3.6.3 资源发送 (单个媒体/媒体组)
- [ ] 3.7 广告展示逻辑
  - [ ] 3.7.1 广告组绑定查询
  - [ ] 3.7.2 顺序轮播实现
  - [ ] 3.7.3 点击统计 (先记录后跳转)
- [ ] 3.8 预览结束逻辑
  - [ ] 3.8.1 资源 < 5: 点击后提示
  - [ ] 3.8.2 资源 = 5: 点击后提示
  - [ ] 3.8.3 资源 > 5: 第5个后直接提示

## 4. Web 后端 API (P0)

- [ ] 4.1 FastAPI 应用初始化
- [ ] 4.2 管理员认证模块
  - [ ] 4.2.1 登录 API
  - [ ] 4.2.2 JWT Token 生成和验证
  - [ ] 4.2.3 密码加密 (bcrypt)
- [ ] 4.3 文件上传服务
  - [ ] 4.3.1 文件接收和保存
  - [ ] 4.3.2 file_id 转换 (发送到私有频道)
  - [ ] 4.3.3 文件大小验证

## 5. Web 后端 API (P1)

- [ ] 5.1 邀请链接 API
  - [ ] 5.1.1 创建邀请链接
  - [ ] 5.1.2 获取邀请链接列表
  - [ ] 5.1.3 更新邀请链接
  - [ ] 5.1.4 删除邀请链接
  - [ ] 5.1.5 生成 Deep Link
- [ ] 5.2 资源管理 API
  - [ ] 5.2.1 上传资源 (单个/媒体组)
  - [ ] 5.2.2 获取资源列表
  - [ ] 5.2.3 更新资源信息
  - [ ] 5.2.4 删除资源
  - [ ] 5.2.5 设置封面
  - [ ] 5.2.6 更新排序
- [ ] 5.3 广告管理 API
  - [ ] 5.3.1 广告组 CRUD
  - [ ] 5.3.2 广告 CRUD
  - [ ] 5.3.3 邀请链接绑定广告组
- [ ] 5.4 统计数据 API
  - [ ] 5.4.1 概览统计
  - [ ] 5.4.2 邀请链接统计
  - [ ] 5.4.3 广告统计
  - [ ] 5.4.4 用户行为统计

## 6. 统计群功能 (P1)

- [ ] 6.1 群组权限过滤中间件
- [ ] 6.2 `/query <名称>` 命令实现
- [ ] 6.3 `/total` 命令实现
- [ ] 6.4 `/help` 命令实现
- [ ] 6.5 统计数据查询服务

## 7. 客服群功能 (P1)

- [ ] 7.1 转发消息识别 (forward_from)
- [ ] 7.2 用户来源查询
- [ ] 7.3 用户信息格式化 (每行一个字段,可复制)
- [ ] 7.4 `/check <ID>` 手动查询命令
- [ ] 7.5 用户行为统计展示

## 8. Web 前端 (P1)

- [ ] 8.1 项目初始化和配置
- [ ] 8.2 登录页面
- [ ] 8.3 布局组件 (侧边栏/导航)
- [ ] 8.4 API 请求封装
- [ ] 8.5 仪表盘页面
- [ ] 8.6 邀请链接管理页面
- [ ] 8.7 资源管理页面
  - [ ] 8.7.1 文件上传组件 (含大小验证)
  - [ ] 8.7.2 资源列表组件
  - [ ] 8.7.3 封面设置
- [ ] 8.8 广告管理页面
- [ ] 8.9 统计报表页面 (ECharts 图表)

## 9. 增强功能 (P2)

- [ ] 9.1 资源拖拽排序
- [ ] 9.2 高级统计图表
  - [ ] 9.2.1 用户留存漏斗
  - [ ] 9.2.2 流失节点分析
  - [ ] 9.2.3 广告效果对比
- [ ] 9.3 数据导出功能
- [ ] 9.4 批量操作
- [ ] 9.5 客服操作日志

## 10. 部署 (P2)

- [ ] 10.1 创建 systemd 服务文件
- [ ] 10.2 配置 Nginx 反向代理
- [ ] 10.3 创建部署脚本
- [ ] 10.4 创建数据库备份脚本
- [ ] 10.5 编写部署文档

## 11. 测试与验证

- [ ] 11.1 Bot 功能测试
- [ ] 11.2 API 接口测试
- [ ] 11.3 前端功能测试
- [ ] 11.4 端到端流程验证
